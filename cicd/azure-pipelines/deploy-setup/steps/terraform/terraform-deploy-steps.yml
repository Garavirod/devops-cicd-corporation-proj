parameters:
  - name: TerraformWorkingDirectory
    type: string
  - name: TFVarsFileNameLocation
    type: string

steps:
  # Configure AWS credentials
  - task: AWSCLI@1
    displayName: 'Configure AWS Credentials'
    inputs:
      awsCredentials: $(AWSServiceConnection)
      regionName: $(awsRegion)
      command: 'configure'

  # Terraform Init
  - task: Bash@3
    displayName: 'Terraform Init'
    inputs:
      targetType: 'inline'
      script: |
       cd ${{ parameters.TerraformWorkingDirectory }}
       terraform init $(TerraformBackendConfig)
  
  # Terraform validate
  - task: Bash@3
    displayName: 'Terraform Validate'
    inputs:
      targetType: 'inline'
      script: |
       cd ${{ parameters.TerraformWorkingDirectory }}
       terraform validate $(TerraformBackendConfig)

  # Terraform plan
  - task: Bash@3
    displayName: 'Terraform Plan'
    inputs:
      targetType: 'inline'
      script: |
       cd ${{ parameters.TerraformWorkingDirectory }}
       terraform plan \
        -out=tfplan \
        -input=false $(TerraformInputVariables) \
        -var-file= ${{ parameters.TFVarsFileNameLocation }} \
  
  # Terraform apply
  - task: Bash@3
    displayName: 'Terraform Apply'
    inputs:
      targetType: 'inline'
      script: |
       cd ${{ parameters.TerraformWorkingDirectory }}
       terraform apply -input=false -auto-approve tfplan
